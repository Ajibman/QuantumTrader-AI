 <!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>QuantumTrader AI™</title>

  <style>
    :root{
      --bg:#000428;
      --card:#071226;
      --muted:#bbb;
      --accent:#1abc9c;
      --danger:#e74c3c;
      --warn:#f1c40f;
      --buy:#2ecc71;
      --sell:#e74c3c;
      --hold:#f39c12;
      --panel-gap:12px;
      --header-gap:18px;
    }

    html,body{
      height:100%; margin:0; padding:0;
      background:var(--bg); 
      font-family:Inter, Arial, sans-serif; 
      color:#fff;
    }
    .container{max-width:1120px; margin:0 auto; padding:18px;}

    header{
      display:flex; 
      align-items:center; 
      justify-content:center; 
      gap:var(--header-gap); 
      margin-top:8px; 
      flex-wrap:wrap;
    }
    .brand-left, .brand-right{display:flex; align-items:center; justify-content:center;}
    .brand-left img, .brand-right img{height:auto; max-height:80px;}

    @media (max-width:520px){
      header{flex-direction:column; gap:8px;}
      .brand-left img, .brand-right img{max-height:64px;}
    }

    h1{font-size:20px; margin:12px 0 6px;}
    h2{font-size:18px; margin:8px 0;}
    p{margin:6px 0; color:var(--muted); font-size:14px;}

    .node-section{margin-top:22px; padding:10px;}
    .card{
      background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.06)); 
      border-radius:10px; 
      padding:14px; 
      box-shadow:0 6px 18px rgba(0,0,0,0.45);
    }

    .center {text-align:center;}

    button.cta{
      background:var(--accent); 
      color:#061018; 
      border:none; 
      padding:12px 20px; 
      border-radius:8px; 
      cursor:pointer; 
      font-weight:700;
    }

    /* Map area */
    #map-area{display:flex; flex-direction:column; gap:12px; align-items:center;}
    #macarthur-map{
      max-width:480px; 
      width:100%; 
      border-radius:8px; 
      cursor:pointer; 
      box-shadow:0 8px 30px rgba(0,0,0,0.6); 
      transition:transform .12s ease, box-shadow .12s ease;
    }
    #macarthur-map:hover{
      transform:translateY(-4px); 
      box-shadow:0 14px 40px rgba(0,0,0,0.7);
    }

    #forex-tooltip{
      position:fixed; 
      display:none; 
      background:rgba(10,12,18,0.97); 
      color:#fff; 
      padding:10px; 
      border-radius:8px; 
      pointer-events:none; 
      z-index:9999; 
      max-width:380px; 
      font-size:13px; 
      box-shadow:0 8px 20px rgba(0,0,0,0.6);
    }

    #currencies-panel{
      margin-top:18px; 
      display:grid; 
      grid-template-columns:repeat(2,1fr); 
      gap:var(--panel-gap);
    }
    @media (max-width:880px){
      #currencies-panel{grid-template-columns:1fr;} 
      .container{padding:12px;}
    }

    .currency-card{
      background:var(--card); 
      border-radius:10px; 
      padding:12px; 
      min-height:64px; 
      transition:transform .12s ease; 
      cursor:pointer; 
      overflow:hidden;
    }
    .currency-card:hover{transform:translateY(-3px);}
    .currency-card .row{
      display:flex; 
      align-items:center; 
      justify-content:space-between;
    }

    .currency-title{font-weight:700; font-size:15px;}
    .signal-pill{
      padding:6px 10px; 
      border-radius:999px; 
      font-weight:700; 
      font-size:13px; 
      color:#061018;
    }
    .signal-buy{background:var(--buy);}
    .signal-sell{background:var(--sell);}
    .signal-hhold{background:var(--hold);}

    .currency-body{margin-top:10px; color:var(--muted); font-size:13px; display:none;}
    .currency-body.open{display:block;}

    .small-kv{font-size:13px; color:var(--muted); margin-top:6px;}
    .muted{color:var(--muted);}
    footer{margin-top:28px; padding:14px; text-align:center; color:var(--muted); font-size:13px;}

    .flex{display:flex; gap:8px; align-items:center;}
    .grow{flex:1;}
  </style>
</head>

<body>
  <div class="container">

<header>
  <div class="brand-left">
    <img src="images/qtai_globe.png" alt="QuantumTrader AI Logo">
  </div>
  <div class="brand-right">
    <a href="https://www.visionofhumanity.org/maps/" target="_blank" rel="noopener noreferrer">
      <img src="images/peace_index_logo.png" alt="Peace Index Logo">
    </a>
  </div>
</header>

<section id="activation-gate" class="node-section center">
  <div class="card">
    <h1>Activation Gate</h1>
    <p class="muted">Proceed to the next stage of QuantumTrader AI</p>
    <div style="margin-top:12px;">
      <button class="cta" id="activation-proceed-btn">Proceed</button>
    </div>
  </div>
</section>

<section id="trading-floor" class="node-section">
  <div class="card flex">
    <div class="grow">
      <h2>Trading Floor</h2>
      <p class="muted">Access Trading Intelligence</p>
    </div>
    <div>
      <button class="cta" id="tradingfloor-btn">Access Trading Floor</button>
    </div>
  </div>
</section>

<section id="map-section" class="node-section">
  <div class="card center" id="map-area">
    <img id="macarthur-map" src="assets/images/macarthur.png" 
         alt="MacArthur Map — click for Global Trade Dashboard" role="button" />
    <p class="muted" style="margin-top:10px;">Click the map to open the Global Trade Dashboard or hover for quick signals</p>
  </div>
  <div id="forex-tooltip" aria-hidden="true"></div>
</section>

<section id="panel-section" class="node-section">
  <div class="card">
    <h2>Top 10 Currencies — Market Engine</h2>
    <p class="muted">Technical Analysis (TA) + Forex Events (FF) — live updates</p>
    <div id="currencies-panel" style="margin-top:12px;"></div>
  </div>
</section>

<section id="traderlab-section" class="node-section">
  <div class="card flex">
    <div class="grow">
      <h2>TraderLab™</h2>
      <p class="muted">Advanced strategy testing</p>
    </div>
    <button class="cta" id="traderlab-btn">Activate TraderLab</button>
  </div>
</section>

<section id="cpilot-section" class="node-section">
  <div class="card flex">
    <div class="grow">
      <h2>CPilot™</h2>
      <p class="muted">Automated guidance & suggestions</p>
    </div>
    <button class="cta" id="cpilot-btn">Activate CPilot</button>
  </div>
</section>

<section id="payment-section" class="node-section">
  <div class="card center">
    <h2>Payment Gate</h2>
    <p class="muted">Opens the secure payment gateway</p>
    <a class="link" href="https://www.alat.com.ng/payment_gateway" target="_blank" rel="noopener noreferrer">
      <img src="assets/images/alat_qr.png" alt="ALAT Payment QR Code" style="width:140px; border-radius:8px;" />
    </a>
    <p class="muted" style="margin-top:10px;">
      Pay NGN10,000 to: <strong>ALAT WEMA - 0299134895 - Olagoke Ajibulu</strong>
    </p>
  </div>
</section>

<footer>
  © 2025 All Rights Reserved | QuantumTrader-AI™
</footer>
</div>

<script>
  const WS_URL = 'ws://localhost:8080';
  const TRACKED_CURRENCIES = ['USD','EUR','JPY','GBP','CNY','CAD','AUD','CHF','INR','KRW'];

  const activationBtn = document.getElementById('activation-proceed-btn');
  const tradingFloorBtn = document.getElementById('tradingfloor-btn');
  const traderLabBtn = document.getElementById('traderlab-btn');
  const cpilotBtn = document.getElementById('cpilot-btn');
  const macarthurMap = document.getElementById('macarthur-map');
  const currenciesPanel = document.getElementById('currencies-panel');
  const tooltip = document.getElementById('forex-tooltip');

  activationBtn.onclick = () => location.href = 'index2.html';
  tradingFloorBtn.onclick = () => location.href = 'tradingfloor.html';
  traderLabBtn.onclick = () => location.href = 'traderlab.html';
  cpilotBtn.onclick = () => location.href = 'cpilot.html';

  macarthurMap.onclick = () => location.href = 'global_trade_dashboard.html';

  const peaceLogo = document.querySelector('.brand-right img');
  if (peaceLogo) {
    peaceLogo.addEventListener('click', () => {
      window.open('https://www.peaceindex.org', '_blank', 'noopener noreferrer');
    });
  }

  (function initHandshakeAndPWA(){
    fetch('/handshake')
      .then(r => r.json())
      .then(d => console.log('Handshake OK', d))
      .catch(err => console.log('Handshake failed', err));

    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/service-worker.js')
        .then(() => console.log('Service worker registered'))
        .catch(err => console.log('SW registration failed', err));
    }
  })();

  let signalsData = [];
  let ws;
  startWS();

  function startWS(){
    ws = new WebSocket(WS_URL);

    ws.onopen = () => console.log('WS connected');

    ws.onmessage = evt => {
      try {
        const payload = JSON.parse(evt.data);
        signalsData = Array.isArray(payload)
          ? payload
          : Object.keys(payload).map(k => ({ currency:k, ...payload[k] }));

        renderCurrencyPanels(signalsData);
        updateTooltipContent(signalsData);

      } catch (e) {
        console.error('Invalid WS data', e);
      }
    };

    ws.onerror = e => console.error('WS error', e);

    ws.onclose = () => {
      console.warn('WS closed — retrying in 3s');
      setTimeout(() => location.reload(), 3000);
    };
  }

  function getSignalPill(sig){
    const s = (sig||'').toLowerCase();
    if (s.includes('buy')) return `<span class="signal-pill signal-buy">BUY</span>`;
    if (s.includes('sell')) return `<span class="signal-pill signal-sell">SELL</span>`;
    return `<span class="signal-pill signal-hold">HOLD</span>`;
  }

  function renderCurrencyPanels(data){
    currenciesPanel.innerHTML = '';
    TRACKED_CURRENCIES.forEach(cur => {
      const row = data.find(d => d.currency?.toUpperCase() === cur);
      const tech = row?.technicalSignals || {};
      const ff = row?.forexFactoryEvents || [];

      const card = document.createElement('div');
      card.className = 'currency-card card';

      const header = document.createElement('div');
      header.className = 'row';
      header.innerHTML = `
        <div class="currency-title">${cur}</div>
        <div>${getSignalPill(aggregateOverall(tech))}</div>
      `;
      card.appendChild(header);

      const body = document.createElement('div');
      body.className = 'currency-body';

      const taHtml = Object.entries(tech).length
        ? Object.entries(tech).map(([k,v]) =>
            `<div class="small-kv"><strong>${escapeHtml(k)}</strong>: ${escapeHtml(String(v))}</div>`
          ).join('')
        : `<div class="small-kv muted">No TA data yet</div>`;

      const ffHtml = ff.length
        ? ff.map(e =>
            `<div class="small-kv"><strong>${escapeHtml(e.event)}</strong> (${escapeHtml(e.impact)}) → ${escapeHtml(e.signal)}</div>`
          ).join('')
        : `<div class="small-kv muted">No FF events</div>`;

      body.innerHTML = `<div>${taHtml}</div><div style="margin-top:10px;"><strong>Forex Events</strong>${ffHtml}</div>`;
      card.appendChild(body);

      card.addEventListener('click', () => {
        const isOpen = body.classList.contains('open');
        document.querySelectorAll('.currency-body').forEach(b => b.classList.remove('open'));
        if (!isOpen) body.classList.add('open');
      });

      currenciesPanel.appendChild(card);
    });
  }

  function aggregateOverall(tech){
    const cnt = {Buy:0, Sell:0, Hold:0};
    Object.values(tech).forEach(v => {
      const t = v.toLowerCase();
      if (t.includes('buy')) cnt.Buy++;
      else if (t.includes('sell')) cnt.Sell++;
      else cnt.Hold++;
    });
    if (cnt.Buy >= cnt.Sell && cnt.Buy >= cnt.Hold) return 'Buy';
    if (cnt.Sell >= cnt.Buy && cnt.Sell >= cnt.Hold) return 'Sell';
    return 'Hold';
  }

  function escapeHtml(str){
    return str.replace(/[&<>"']/g, m => ({
      '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
    }[m]));
  }

  function updateTooltipContent(data){
    tooltip.innerHTML = data.length
      ? data.slice(0,10).map(d => {
          const ov = aggregateOverall(d.technicalSignals || {});
          const events = (d.forexFactoryEvents || []).length;
          return `<div style="margin-bottom:6px;"><strong>${escapeHtml(d.currency)}</strong> — ${ov} — ${events || 'no'} event(s)</div>`;
        }).join('')
      : '<div class="muted">No live signals</div>';
  }

  macarthurMap.onmousemove = e => {
    tooltip.style.left = (e.pageX + 14) + 'px';
    tooltip.style.top = (e.pageY + 14) + 'px';
  };
  macarthurMap.onmouseover = () => {
    tooltip.style.display = 'block';
    tooltip.setAttribute('aria-hidden','false');
    updateTooltipContent(signalsData);
  };
  macarthurMap.onmouseout = () => {
    tooltip.style.display = 'none';
    tooltip.setAttribute('aria-hidden','true');
  };

  document.addEventListener('DOMContentLoaded', () => {
    renderCurrencyPanels([]);
    updateTooltipContent([]);
  });
</script>

</body>
</html>

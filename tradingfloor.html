 <!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>QuantumTrader AIâ„¢ â€” Trading Floor</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<style>
  body {
    background: #050b1f;
    color: #e8f1ff;
    font-family: system-ui, sans-serif;
    margin: 0;
    padding: 24px;
  }

  .card {
    background: #0b1736;
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 20px;
  }

  .locked {
    opacity: 0.4;
    pointer-events: none;
  }

  .warning {
    color: #ffb347;
    font-weight: 600;
  }

  button {
    padding: 10px 16px;
    border-radius: 8px;
    border: none;
    cursor: pointer;
    background: #7cf3ff;
    color: #000;
    font-weight: 600;
  }
</style>
</head>

<body>

<h1>ðŸ“ˆ Trading Floor</h1>

<div id="gateMessage" class="card warning" style="display:none;"></div>

<div id="tradingApp" class="card">
  <h3>Wallet Balance</h3>
  <p id="walletBalance">â‚¦0.00</p>

  <button onclick="executeTrade()">Execute Trade</button>

  <h4 style="margin-top:20px;">Recent Wallet Activity</h4>
  <ul id="walletHistory"></ul>
</div>

<script type="module">
import Wallet from "./wallet.js";
import State from "./state.js";

/* ---------------------------
   PERMISSION GATING
---------------------------- */
const gateMessage = document.getElementById("gateMessage");
const tradingApp = document.getElementById("tradingApp");

const user = State.getCurrentUser();

if (!user) {
  lock("User session not found.");
}
else if (!State.hasActiveSubscription(user.id)) {
  lock("Subscription expired. Trading Floor locked.");
}
else if (!State.hasPassedTraderLab(user.id)) {
  lock("TraderLab not completed. Access denied.");
}
else {
  unlock();
  initTradingFloor(user.id);
}

function lock(message) {
  tradingApp.classList.add("locked");
  gateMessage.textContent = message;
  gateMessage.style.display = "block";
}

function unlock() {
  gateMessage.style.display = "none";
  tradingApp.classList.remove("locked");
}

/* ---------------------------
   INIT FLOOR
---------------------------- */
function initTradingFloor(userId) {
  Wallet.ensureWallet(userId);
  renderBalance(userId);
  renderHistory(userId);
}

/* ---------------------------
   UI RENDERERS
---------------------------- */
function renderBalance(userId) {
  const bal = Wallet.getBalance(userId);
  document.getElementById("walletBalance").textContent =
    `â‚¦${bal.toFixed(2)}`;
}

function renderHistory(userId) {
  const history = Wallet.getHistory(userId).slice(-5).reverse();
  const ul = document.getElementById("walletHistory");
  ul.innerHTML = "";

  history.forEach(h => {
    const li = document.createElement("li");
    li.textContent = `${h.type.toUpperCase()} â€” â‚¦${h.amount} (${h.source})`;
    ul.appendChild(li);
  });
}

/* ---------------------------
   TRADE EXECUTION
---------------------------- */
window.executeTrade = function () {
  const userId = State.getCurrentUser().id;

  const stake = 1000;
  if (Wallet.getBalance(userId) < stake) {
    alert("Insufficient wallet balance.");
    return;
  }

  // Capital is referenced, NOT destroyed
  Wallet.recordHistory(userId, {
    type: "trade",
    amount: stake,
    source: "TradingFloor",
    note: "Capital deployed to market"
  });

  // Simulated profit
  const profit = Math.floor(Math.random() * 1500);

  Wallet.deposit(userId, profit, "TradingFloor Profit");

  renderBalance(userId);
  renderHistory(userId);
};
</script>

</body>
</html>

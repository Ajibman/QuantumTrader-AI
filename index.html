<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>QuantumTrader AIâ„¢</title>

  <!-- Trusted core styles -->
  <link rel="stylesheet" href="css/core.css">
  <link rel="stylesheet" href="css/layout.css">
  <link rel="stylesheet" href="css/components.css">

  <!-- JS protection script -->
  <script>
    const allowedCSS = [
        'css/core.css',
        'css/layout.css',
        'css/components.css'
    ];
    document.querySelectorAll('link[rel="stylesheet"]').forEach(link => {
        const href = link.getAttribute('href');
        if (!allowedCSS.includes(href)) {
            link.remove();
            console.warn('Removed untrusted CSS:', href);
        }
    });
  </script>
</head>

<body>
<div class="container">

  <!-- FINAL, SINGLE, CLEAN HEADER -->
  <header class="qta-header">

    <!-- Left: World Drawer btn -->
    <button id="open-world-drawer" class="icon-btn" aria-label="Open world drawer" title="World">
      <span class="sr-only">Open World Drawer</span>
      <img src="images/qtai_globe.png" alt="QT-AI Globe" class="header-icon" />
    </button>

    <!-- Center Logos -->
    <div class="header-center">
      <img src="images/qtai_globe.png" alt="QuantumTrader AI Logo" class="center-logo" />
      <a href="https://www.visionofhumanity.org/maps/" target="_blank" rel="noopener noreferrer">
        <img src="images/peace_index_logo.png" alt="Peace Index Logo" class="center-logo" />
      </a>
    </div>

    <!-- Right: Compass Menu -->
    <div class="header-right">
      <button id="compass-toggle" class="icon-btn" aria-haspopup="true" aria-expanded="false" aria-label="Open system menu" title="System">
        <span class="sr-only">Open System Menu</span>
        <span class="compass-icon">ðŸ§­</span>
      </button>

      <!-- Dropdown -->
      <div id="compass-dropdown" class="dropdown hidden" role="menu">
        <ul>
          <li><button class="dropdown-item" data-open="settings.html">Settings</button></li>
          <li><button class="dropdown-item" data-open="developer.html">Developer Panel</button></li>
          <li><button class="dropdown-item" data-open="logs.html">Activation Logs</button></li>
          <li><button class="dropdown-item" data-open="docs.html">Documentation</button></li>
          <li><button class="dropdown-item" data-open="pwa-tools.html">PWA Tools</button></li>
          <li><button class="dropdown-item" data-open="about.html">About</button></li>
        </ul>
      </div>
    </div>

  </header>

  <!-- WORLD DRAWER -->
  <nav id="world-drawer" class="world-drawer closed" aria-hidden="true">
    <div class="drawer-header">
      <button id="close-world-drawer" class="close-btn">âœ•</button>
      <h2>World Access</h2>
    </div>

    <div class="drawer-sections">
      <!-- Global Markets -->
      <section class="drawer-section">
        <h3>Global Markets</h3>
        <ul>
          <li><button class="drawer-link" data-open="markets/forex.html">Forex</button></li>
          <li><button class="drawer-link" data-open="markets/crypto.html">Cryptocurrency</button></li>
          <li><button class="drawer-link" data-open="markets/metals.html">Metals</button></li>
          <li><button class="drawer-link" data-open="markets/solid-minerals.html">Solid Minerals</button></li>
          <li><button class="drawer-link" data-open="markets/oil.html">Oil / Energy</button></li>
          <li><button class="drawer-link" data-open="markets/sp500.html">S&P 500</button></li>
          <li><button class="drawer-link" data-open="markets/bonds.html">Bonds</button></li>
          <li><button class="drawer-link" data-open="markets/foods.html">Foods / Agric Commodities</button></li>
          <li><button class="drawer-link" data-open="markets/logistics.html">Global Logistics</button></li>
        </ul>
      </section>
    </div>

    <footer class="drawer-footer">
      <small>QuantumTrader AIâ„¢ â€” World Access</small>
    </footer>
  </nav>

  <!-- Drawer overlay -->
  <div id="drawer-overlay" class="drawer-overlay hidden"></div>

    <!-- Agricultural Cooperatives -->
    <section class="drawer-section">
      <h3>Agricultural Cooperatives</h3>
      <ul>
        <li><button class="drawer-link" data-open="coops/community-trade.html">Community Trade Networks</button></li>
        <li><button class="drawer-link" data-open="coops/crop-systems.html">Crop Systems</button></li>
        <li><button class="drawer-link" data-open="coops/exchange.html">Co-op Exchange</button></li>
        <li><button class="drawer-link" data-open="coops/governance.html">Governance Tools</button></li>
        <li><button class="drawer-link" data-open="coops/produce-index.html">Produce Index Tracker</button></li>
      </ul>
    </section>

    <!-- NGOs -->
    <section class="drawer-section">
      <h3>NGOs</h3>
      <ul>
        <li><button class="drawer-link" data-open="ngos/stability-index.html">Regional Stability Index</button></li>
        <li><button class="drawer-link" data-open="ngos/aid-maps.html">Aid Distribution Maps</button></li>
        <li><button class="drawer-link" data-open="ngos/logistics.html">Humanitarian Logistics</button></li>
        <li><button class="drawer-link" data-open="ngos/impact.html">Impact Metrics & Reports</button></li>
        <li><button class="drawer-link" data-open="ngos/peace-analytics.html">Peace Analytics</button></li>
      </ul>
    </section>
  </div>

  <footer class="drawer-footer">
    <small>QuantumTrader AIâ„¢ â€” World Access</small>
  </footer>
</nav>

<!-- overlay -->
<div id="drawer-overlay" class="drawer-overlay hidden" tabindex="-1" aria-hidden="true"></div>
  
  <div class="brand-left">
    <img src="images/qtai_globe.png" alt="QuantumTrader AI Logo">
  </div>
  <div class="brand-right">
    <a href="https://www.visionofhumanity.org/maps/" target="_blank" rel="noopener noreferrer">
      <img src="images/peace_index_logo.png" alt="Peace Index Logo">
    </a>
  </div>
</header>

<section id="activation-gate" class="node-section center">
  <div class="card">
    <h1>Activation Gate</h1>
    <p class="muted">Proceed to the next stage of QuantumTrader AI</p>
    <div style="margin-top:12px;">
      <button class="cta" id="activation-proceed-btn">Proceed</button>
    </div>
  </div>
</section>

<section id="trading-floor" class="node-section">
  <div class="card flex">
    <div class="grow">
      <h2>Trading Floor</h2>
      <p class="muted">Access Trading Intelligence</p>
    </div>
    <div>
      <button class="cta" id="tradingfloor-btn">Access Trading Floor</button>
    </div>
  </div>
</section>

<section id="map-section" class="node-section">
  <div class="card center" id="map-area">
    <img id="macarthur-map" src="assets/images/macarthur.png" 
         alt="MacArthur Map â€” click for Global Trade Dashboard" role="button" />
    <p class="muted" style="margin-top:10px;">Click the map to open the Global Trade Dashboard or hover for quick signals</p>
  </div>
  <div id="forex-tooltip" aria-hidden="true"></div>
</section>

<section id="panel-section" class="node-section">
  <div class="card">
    <h2>Top 10 Currencies â€” Market Engine</h2>
    <p class="muted">Technical Analysis (TA) + Forex Events (FF) â€” live updates</p>
    <div id="currencies-panel" style="margin-top:12px;"></div>
  </div>
</section>

<section id="traderlab-section" class="node-section">
  <div class="card flex">
    <div class="grow">
      <h2>TraderLabâ„¢</h2>
      <p class="muted">Advanced strategy testing</p>
    </div>
    <button class="cta" id="traderlab-btn">Activate TraderLab</button>
  </div>
</section>

<section id="cpilot-section" class="node-section">
  <div class="card flex">
    <div class="grow">
      <h2>CPilotâ„¢</h2>
      <p class="muted">Automated guidance & suggestions</p>
    </div>
    <button class="cta" id="cpilot-btn">Activate CPilot</button>
  </div>
</section>

<section id="payment-section" class="node-section">
  <div class="card center">
    <h2>Payment Gate</h2>
    <p class="muted">Opens the secure payment gateway</p>
    <a class="link" href="https://www.alat.com.ng/payment_gateway" target="_blank" rel="noopener noreferrer">
      <img src="assets/images/alat_qr.png" alt="ALAT Payment QR Code" style="width:140px; border-radius:8px;" />
    </a>
    <p class="muted" style="margin-top:10px;">
      Pay NGN10,000 to: <strong>ALAT WEMA - 0299134895 - Olagoke Ajibulu</strong>
    </p>
  </div>
</section>

<footer>
  Â© 2025 All Rights Reserved | QuantumTrader-AIâ„¢
</footer>
</div>

<script>
  const WS_URL = 'ws://localhost:8080';
  const TRACKED_CURRENCIES = ['USD','EUR','JPY','GBP','CNY','CAD','AUD','CHF','INR','KRW'];

  const activationBtn = document.getElementById('activation-proceed-btn');
  const tradingFloorBtn = document.getElementById('tradingfloor-btn');
  const traderLabBtn = document.getElementById('traderlab-btn');
  const cpilotBtn = document.getElementById('cpilot-btn');
  const macarthurMap = document.getElementById('macarthur-map');
  const currenciesPanel = document.getElementById('currencies-panel');
  const tooltip = document.getElementById('forex-tooltip');

  activationBtn.onclick = () => location.href = 'index2.html';
  tradingFloorBtn.onclick = () => location.href = 'tradingfloor.html';
  traderLabBtn.onclick = () => location.href = 'traderlab.html';
  cpilotBtn.onclick = () => location.href = 'cpilot.html';

  macarthurMap.onclick = () => location.href = 'global_trade_dashboard.html';

  const peaceLogo = document.querySelector('.brand-right img');
  if (peaceLogo) {
    peaceLogo.addEventListener('click', () => {
      window.open('https://www.peaceindex.org', '_blank', 'noopener noreferrer');
    });
  }

  (function initHandshakeAndPWA(){
    fetch('/handshake')
      .then(r => r.json())
      .then(d => console.log('Handshake OK', d))
      .catch(err => console.log('Handshake failed', err));

    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/service-worker.js')
        .then(() => console.log('Service worker registered'))
        .catch(err => console.log('SW registration failed', err));
    }
  })();

  let signalsData = [];
  let ws;
  startWS();

  function startWS(){
    ws = new WebSocket(WS_URL);

    ws.onopen = () => console.log('WS connected');

    ws.onmessage = evt => {
      try {
        const payload = JSON.parse(evt.data);
        signalsData = Array.isArray(payload)
          ? payload
          : Object.keys(payload).map(k => ({ currency:k, ...payload[k] }));

        renderCurrencyPanels(signalsData);
        updateTooltipContent(signalsData);

      } catch (e) {
        console.error('Invalid WS data', e);
      }
    };

    ws.onerror = e => console.error('WS error', e);

    ws.onclose = () => {
      console.warn('WS closed â€” retrying in 3s');
      setTimeout(() => location.reload(), 3000);
    };
  }

  function getSignalPill(sig){
    const s = (sig||'').toLowerCase();
    if (s.includes('buy')) return `<span class="signal-pill signal-buy">BUY</span>`;
    if (s.includes('sell')) return `<span class="signal-pill signal-sell">SELL</span>`;
    return `<span class="signal-pill signal-hold">HOLD</span>`;
  }

  function renderCurrencyPanels(data){
    currenciesPanel.innerHTML = '';
    TRACKED_CURRENCIES.forEach(cur => {
      const row = data.find(d => d.currency?.toUpperCase() === cur);
      const tech = row?.technicalSignals || {};
      const ff = row?.forexFactoryEvents || [];

      const card = document.createElement('div');
      card.className = 'currency-card card';

      const header = document.createElement('div');
      header.className = 'row';
      header.innerHTML = `
        <div class="currency-title">${cur}</div>
        <div>${getSignalPill(aggregateOverall(tech))}</div>
      `;
      card.appendChild(header);

      const body = document.createElement('div');
      body.className = 'currency-body';

      const taHtml = Object.entries(tech).length
        ? Object.entries(tech).map(([k,v]) =>
            `<div class="small-kv"><strong>${escapeHtml(k)}</strong>: ${escapeHtml(String(v))}</div>`
          ).join('')
        : `<div class="small-kv muted">No TA data yet</div>`;

      const ffHtml = ff.length
        ? ff.map(e =>
            `<div class="small-kv"><strong>${escapeHtml(e.event)}</strong> (${escapeHtml(e.impact)}) â†’ ${escapeHtml(e.signal)}</div>`
          ).join('')
        : `<div class="small-kv muted">No FF events</div>`;

      body.innerHTML = `<div>${taHtml}</div><div style="margin-top:10px;"><strong>Forex Events</strong>${ffHtml}</div>`;
      card.appendChild(body);

      card.addEventListener('click', () => {
        const isOpen = body.classList.contains('open');
        document.querySelectorAll('.currency-body').forEach(b => b.classList.remove('open'));
        if (!isOpen) body.classList.add('open');
      });

      currenciesPanel.appendChild(card);
    });
  }

  function aggregateOverall(tech){
    const cnt = {Buy:0, Sell:0, Hold:0};
    Object.values(tech).forEach(v => {
      const t = v.toLowerCase();
      if (t.includes('buy')) cnt.Buy++;
      else if (t.includes('sell')) cnt.Sell++;
      else cnt.Hold++;
    });
    if (cnt.Buy >= cnt.Sell && cnt.Buy >= cnt.Hold) return 'Buy';
    if (cnt.Sell >= cnt.Buy && cnt.Sell >= cnt.Hold) return 'Sell';
    return 'Hold';
  }

  function escapeHtml(str){
    return str.replace(/[&<>"']/g, m => ({
      '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
    }[m]));
  }

  function updateTooltipContent(data){
    tooltip.innerHTML = data.length
      ? data.slice(0,10).map(d => {
          const ov = aggregateOverall(d.technicalSignals || {});
          const events = (d.forexFactoryEvents || []).length;
          return `<div style="margin-bottom:6px;"><strong>${escapeHtml(d.currency)}</strong> â€” ${ov} â€” ${events || 'no'} event(s)</div>`;
        }).join('')
      : '<div class="muted">No live signals</div>';
  }

  macarthurMap.onmousemove = e => {
    tooltip.style.left = (e.pageX + 14) + 'px';
    tooltip.style.top = (e.pageY + 14) + 'px';
  };
  macarthurMap.onmouseover = () => {
    tooltip.style.display = 'block';
    tooltip.setAttribute('aria-hidden','false');
    updateTooltipContent(signalsData);
  };
  macarthurMap.onmouseout = () => {
    tooltip.style.display = 'none';
    tooltip.setAttribute('aria-hidden','true');
  };

  document.addEventListener('DOMContentLoaded', () => {
    renderCurrencyPanels([]);
    updateTooltipContent([]);
  });
</script>

<script>
const allowedCSS = [
  'css/core.css',
  'css/layout.css',
  'css/components.css'
];

document.addEventListener('DOMContentLoaded', () => {
  document.querySelectorAll('link[rel="stylesheet"]').forEach(link => {
    const href = link.getAttribute('href');
    if (!allowedCSS.includes(href)) {
      link.remove();
      console.warn('Removed untrusted CSS:', href);
    }
  });
});
</script>
  
</body>
</html>
